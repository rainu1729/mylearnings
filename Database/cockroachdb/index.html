<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="rainuN" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>CockroachDB - My Learning Journey</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "CockroachDB";
        var mkdocs_page_input_path = "Database/cockroachdb.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> My Learning Journey
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../about/">About</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Database</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../questions/">Oracle</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../snowflakes/">Snowflakes</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">CockroachDB</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../postgresql/">PostgreSQL</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gcbigquery/">GCbigquery</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cloud</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Cloud/gcp/">GCP</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Container</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Containerization/docker/">Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../Containerization/terraform/">Terraform</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Scripting</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Scripting/shellscripting/">UnixShell</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Scheduler</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../Scheduler/airflow/">Airflow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">My Learning Journey</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Database</li>
      <li class="breadcrumb-item active">CockroachDB</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>Okay, let's set up a 3-node CockroachDB cluster on your local machine using Docker and Terraform.</p>
<p>This setup will be <strong>insecure</strong> (no SSL certificates) for simplicity on a local machine. For production, you'd need to configure security.</p>
<p><strong>Prerequisites:</strong></p>
<ol>
<li><strong>Docker Desktop (or Docker Engine):</strong> Ensure Docker is installed and running.<ul>
<li>Install: <a href="/Containerization/docker">Docker Installation</a></li>
</ul>
</li>
<li><strong>Terraform:</strong> Install the Terraform CLI.<ul>
<li>Install: <a href="/Containerization/terraform">Terraform Installation</a></li>
</ul>
</li>
<li><strong>Install client tools like DBeaver:</strong><ul>
<li>Install: <a href="https://dbeaver.io/">DBeaver</a></li>
</ul>
</li>
</ol>
<p><strong>Step 1: Project Setup</strong></p>
<ol>
<li>Create a new directory for your project, e.g., <code>cockroach-tf-docker</code>.</li>
<li>Navigate into this directory: <code>cd cockroach-tf-docker</code></li>
</ol>
<p><strong>Step 2: Create Terraform Configuration File (<code>main.tf</code>)</strong></p>
<p>Create a file named <code>main.tf</code> in your <code>cockroach-tf-docker</code> directory and paste the following content:</p>
<pre><code class="language-json">terraform
terraform {
  required_providers {
    docker = {
      source  = &quot;kreuzwerker/docker&quot;
      version = &quot;~&gt; 3.0&quot; # Or latest compatible version
    }
  }
}

provider &quot;docker&quot; {}

# Define a Docker network for the cluster nodes to communicate
resource &quot;docker_network&quot; &quot;roachnet&quot; {
  name = &quot;roachnet&quot;
}

# --- Node 1 ---
resource &quot;docker_volume&quot; &quot;roach1_data&quot; {
  name = &quot;roach1_data&quot;
}

resource &quot;docker_container&quot; &quot;roach1&quot; {
  name     = &quot;roach1&quot;
  hostname = &quot;roach1&quot;
  image    = &quot;cockroachdb/cockroach:v23.2.1&quot; # Use a specific version

  networks_advanced {
    name    = docker_network.roachnet.name
    aliases = [&quot;roach1&quot;]
  }

  ports {
    internal = 26257 # SQL port
    external = 26257
  }
  ports {
    internal = 8080  # DB Console HTTP port
    external = 8080
  }

  volumes {
    volume_name    = docker_volume.roach1_data.name
    container_path = &quot;/cockroach/cockroach-data&quot;
  }

  # Command to start the first node
  # --insecure: Use insecure mode (no TLS)
  # --join: List of nodes to join (itself and others)
  # --advertise-addr: Address other nodes use to reach this one (must be resolvable within the docker network)
  # --listen-addr: Address this node listens on within the container
  # --http-addr: Address for the DB Console within the container
  command = [
    &quot;start&quot;,
    &quot;--insecure&quot;,
    &quot;--join=roach1:26257,roach2:26257,roach3:26257&quot;,
    &quot;--advertise-addr=roach1:26257&quot;,
    &quot;--listen-addr=0.0.0.0:26257&quot;,
    &quot;--http-addr=0.0.0.0:8080&quot;,
    &quot;--cache=.25&quot;,      # Limit cache size for local dev
    &quot;--max-sql-memory=.25&quot; # Limit SQL memory for local dev
  ]

  restart = &quot;unless-stopped&quot;
}

# --- Node 2 ---
resource &quot;docker_volume&quot; &quot;roach2_data&quot; {
  name = &quot;roach2_data&quot;
}

resource &quot;docker_container&quot; &quot;roach2&quot; {
  name     = &quot;roach2&quot;
  hostname = &quot;roach2&quot;
  image    = docker_container.roach1.image # Use the same image as node 1

  networks_advanced {
    name    = docker_network.roachnet.name
    aliases = [&quot;roach2&quot;]
  }

  ports {
    internal = 26257
    external = 26258 # Expose on a different host port
  }
  ports {
    internal = 8080
    external = 8081  # Expose on a different host port
  }

  volumes {
    volume_name    = docker_volume.roach2_data.name
    container_path = &quot;/cockroach/cockroach-data&quot;
  }

  command = [
    &quot;start&quot;,
    &quot;--insecure&quot;,
    &quot;--join=roach1:26257,roach2:26257,roach3:26257&quot;, # Join the first node
    &quot;--advertise-addr=roach2:26257&quot;,
    &quot;--listen-addr=0.0.0.0:26257&quot;,
    &quot;--http-addr=0.0.0.0:8080&quot;,
    &quot;--cache=.25&quot;,
    &quot;--max-sql-memory=.25&quot;
  ]

  # Ensure roach1 is started before roach2 attempts to join
  depends_on = [docker_container.roach1]
  restart    = &quot;unless-stopped&quot;
}

# --- Node 3 ---
resource &quot;docker_volume&quot; &quot;roach3_data&quot; {
  name = &quot;roach3_data&quot;
}

resource &quot;docker_container&quot; &quot;roach3&quot; {
  name     = &quot;roach3&quot;
  hostname = &quot;roach3&quot;
  image    = docker_container.roach1.image # Use the same image as node 1

  networks_advanced {
    name    = docker_network.roachnet.name
    aliases = [&quot;roach3&quot;]
  }

  ports {
    internal = 26257
    external = 26259 # Expose on a different host port
  }
  ports {
    internal = 8080
    external = 8082  # Expose on a different host port
  }

  volumes {
    volume_name    = docker_volume.roach3_data.name
    container_path = &quot;/cockroach/cockroach-data&quot;
  }

  command = [
    &quot;start&quot;,
    &quot;--insecure&quot;,
    &quot;--join=roach1:26257,roach2:26257,roach3:26257&quot;, # Join the first node
    &quot;--advertise-addr=roach3:26257&quot;,
    &quot;--listen-addr=0.0.0.0:26257&quot;,
    &quot;--http-addr=0.0.0.0:8080&quot;,
    &quot;--cache=.25&quot;,
    &quot;--max-sql-memory=.25&quot;
  ]

  depends_on = [docker_container.roach1] # Also depends on roach1
  restart    = &quot;unless-stopped&quot;
}

# --- Outputs ---
output &quot;db_console_node1&quot; {
  description = &quot;DB Console URL for Node 1&quot;
  value       = &quot;http://localhost:8080&quot;
}

output &quot;db_console_node2&quot; {
  description = &quot;DB Console URL for Node 2&quot;
  value       = &quot;http://localhost:8081&quot;
}

output &quot;db_console_node3&quot; {
  description = &quot;DB Console URL for Node 3&quot;
  value       = &quot;http://localhost:8082&quot;
}

output &quot;sql_connection_node1&quot; {
  description = &quot;SQL connection string for Node 1 (using CockroachDB client)&quot;
  value       = &quot;cockroach sql --insecure --host=localhost --port=26257&quot;
}

output &quot;sql_connection_node2&quot; {
  description = &quot;SQL connection string for Node 2 (using CockroachDB client)&quot;
  value       = &quot;cockroach sql --insecure --host=localhost --port=26258&quot;
}

output &quot;sql_connection_node3&quot; {
  description = &quot;SQL connection string for Node 3 (using CockroachDB client)&quot;
  value       = &quot;cockroach sql --insecure --host=localhost --port=26259&quot;
}

output &quot;psql_connection_node1&quot; {
  description = &quot;PostgreSQL compatible connection string for Node 1&quot;
  value       = &quot;postgresql://root@localhost:26257/defaultdb?sslmode=disable&quot;
}
</code></pre>
<p><strong>Step 3: Initialize Terraform</strong></p>
<p>Open your terminal in the <code>cockroach-tf-docker</code> directory and run:</p>
<pre><code class="language-bash">terraform init
</code></pre>
<p>This command downloads the necessary Docker provider plugin.</p>
<p><strong>Step 4: Plan the Deployment</strong></p>
<p>Run the following command to see what Terraform will create:</p>
<pre><code class="language-bash">terraform plan
</code></pre>
<p>Review the plan to ensure it's going to create three Docker containers, one network, and three volumes.</p>
<p><strong>Step 5: Apply the Configuration (Spin up the cluster)</strong></p>
<p>Execute the command to create the resources:</p>
<pre><code class="language-bash">terraform apply
</code></pre>
<p>Terraform will ask for confirmation. Type <code>yes</code> and press Enter.
This will:
1.  Create the <code>roachnet</code> Docker network.
2.  Create the <code>roachX_data</code> Docker volumes.
3.  Pull the <code>cockroachdb/cockroach</code> image if you don't have it.
4.  Start the three <code>roachX</code> containers.</p>
<p>Wait for the command to complete. It might take a minute or two for the nodes to start and find each other.</p>
<p><strong>Step 6: Initialize the CockroachDB Cluster</strong></p>
<p>Once the containers are running, you need to perform a one-time initialization of the cluster. This tells one of the nodes to bootstrap the cluster.</p>
<p>You can do this by executing the <code>cockroach init</code> command inside one of the containers. We'll use <code>roach1</code>:</p>
<pre><code class="language-bash">docker exec -it roach1 ./cockroach init --insecure
</code></pre>
<p>You should see a success message like:
<code>Cluster successfully initialized</code></p>
<p><strong>Step 7: Verify the Cluster</strong></p>
<ol>
<li>
<p><strong>DB Console:</strong></p>
<ul>
<li>Open your web browser and go to <code>http://localhost:8080</code> (for roach1).</li>
<li>You should see the CockroachDB Console.</li>
<li>Click on "View nodes list" on the metrics overview page or navigate to "Cluster Overview" -&gt; "Nodes". You should see all 3 nodes listed as healthy.</li>
<li>You can also access the console for other nodes: <code>http://localhost:8081</code> (roach2) and <code>http://localhost:8082</code> (roach3).</li>
</ul>
</li>
<li>
<p><strong>SQL Client (using the CockroachDB binary):</strong>
    If you have the <code>cockroach</code> binary installed locally:
    <code>bash
    cockroach sql --insecure --host=localhost --port=26257</code>
    Or connect to another node:
    <code>bash
    cockroach sql --insecure --host=localhost --port=26258</code>
    Once connected, try some commands:
    <code>sql
    SHOW DATABASES;
    CREATE DATABASE myapp;
    USE myapp;
    CREATE TABLE users (id INT PRIMARY KEY, name STRING);
    INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob');
    SELECT * FROM users;
    SHOW RANGES FROM TABLE users; -- See data distribution
    \q</code>
<strong>Step 8: Manage and Clean Up</strong></p>
</li>
<li>
<p><strong>View running containers:</strong> <code>docker ps</code></p>
</li>
<li><strong>View container logs:</strong> <code>docker logs roach1</code> (or <code>roach2</code>, <code>roach3</code>)</li>
<li><strong>Stop and remove the cluster (Terraform):</strong>
    When you're done, you can destroy all resources managed by Terraform:
    <code>bash
    terraform destroy</code>
    Type <code>yes</code> to confirm. This will stop and remove the containers, network, and volumes.</li>
</ol>
<p><strong>Important Considerations:</strong></p>
<ul>
<li><strong>Insecure Mode:</strong> This setup uses <code>--insecure</code>. <strong>Never use this for production.</strong> Production deployments require proper TLS certificates for secure communication between nodes and clients.</li>
<li><strong>Data Persistence:</strong> The <code>docker_volume</code> resources ensure that your data persists even if the containers are stopped and restarted (as long as the volumes are not deleted). If you run <code>terraform destroy</code>, the volumes will also be removed by default.</li>
<li><strong>Resource Limits:</strong> The <code>--cache</code> and <code>--max-sql-memory</code> flags are set low for local development. For more serious use, you'd adjust these or remove them to let CockroachDB use more resources.</li>
<li><strong>CockroachDB Version:</strong> Pinning the <code>cockroachdb/cockroach</code> image version (e.g., <code>:v23.2.1</code>) is good practice for reproducibility.</li>
<li><strong><code>depends_on</code>:</strong> While <code>depends_on</code> helps guide Terraform's creation order, CockroachDB nodes are designed to find each other and form a cluster even if they start in a slightly different order, as long as the <code>--join</code> flags are correct and network connectivity exists.</li>
</ul>
<p>You now have a 3-node CockroachDB cluster running locally, managed by Terraform!</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../snowflakes/" class="btn btn-neutral float-left" title="Snowflakes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../postgresql/" class="btn btn-neutral float-right" title="PostgreSQL">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../snowflakes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../postgresql/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
      <script src="../../js/open_in_new_tab.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
